import{p as t,l as e,I as s,d as i,n as r}from"./index.91c1d8ee.js";import{p as l}from"./utils.6db6fdf7.js";import{R as a}from"./refresh.25a39116.js";import"./vendor.3a85f146.js";const o=[{colKey:"row-select",type:"multiple",className:"demo-single-select-cell",checkProps:{allowUncheck:!0},width:24,fixed:"left"},{title:"进程ID",minWidth:"400px",width:"400px",align:"left",colKey:"value",cell:"value"},{align:"left",ellipsis:!0,colKey:"op",cell:"op",title:"采集"}];function c(t){switch(t){case"ProfCPU":case"CPU":return"cpu";case"ProfMemory":case"Memory":return"mem";case"ProfBlock":case"Block":return"block";case"ProfMutex":case"Mutex":return"mutex";case"ProfGoroutine":case"Goroutine":return"goroutine";case"ProfThreadCreate":case"ThreadCreate":return"thread";case"ProfTrace":case"Trace":return"trace"}return""}var n={name:"cmd",components:{RefreshIcon:a},data:()=>({prefix:t,params:{cluster:"dev",svr:"profsvr"},ids:[],svrCol:[{title:"",colKey:"svr",width:"190px"},{title:"",align:e,colKey:"num"}],svrRows:[],idsRows:[],idsCol:o,idsPagi:!1,idsLoading:!1,collectType:"",dialogVisible:!1,dialogValue:"normal",recordRows:[],recordData:[],recordLoading:!1}),computed:{NewParams(){return JSON.parse(JSON.stringify(this.params))},RecordColumns(){return[{align:"left",title:"时间",colKey:"starttime",width:"190px",ellipsis:!0},{title:"ID",colKey:"id",minWidth:"400px",width:"400px",ellipsis:!0},{title:"进度",colKey:"process",width:"100px"},{title:"类型",colKey:"displaytyp",width:"140px"},{title:"操作",colKey:"op",width:"140px"},{title:"备注",minWidth:"140px",colKey:"comment",edit:{component:s,props:{clearable:!0,autofocus:!0},abortEditOnEvent:["onEnter"],onEdited:t=>{console.log("Edit Note:",t),this.recordData.splice(t.rowIndex,1,t.newRowData),this.updateNote(t.newRowData)},defaultEditable:!1}}]},clusterlist(){if(0===this.ids.length)return[{label:"other",value:"other"}];const t=[];for(let e=0;e<this.ids.length;e++){const s=this.ids[e];t.push({label:s.clusterName,value:s.cluster})}return t},svrlist(){if(0===this.ids.length)return[];const t=[];for(let e=0;e<this.ids.length;e++){const s=this.ids[e];if(s.cluster===this.params.cluster)for(let e=0;e<s.svr.length;e++){const i=s.svr[e];t.push({label:i.svr,value:i.svr,svr:i.svr,num:i.id.length})}}return t.sort(((t,e)=>t.svr>e.svr?1:t.svr<e.svr?-1:0))},idlist(){if(0===this.ids.length)return[{value:"/202/battle/dsagentsvr/daily/9.143.93.36/1"},{value:"/202/battle/dsagentsvr/daily/9.143.93.36/2"},{value:"/202/battle/dsagentsvr/daily/9.143.93.36/3"}];const t=[];for(let e=0;e<this.ids.length;e++){const s=this.ids[e];if(s.cluster===this.params.cluster)for(let e=0;e<s.svr.length;e++){const i=s.svr[e];if(i.svr===this.params.svr)for(let e=0;e<i.id.length;e++){const s=i.id[e];t.push({label:s,value:s})}}}return console.log("idlist",t),t},collectBody(){let t="";return this.idsRows.forEach((e=>{if(""!==t)return t=`${t}, ${e}`,!0;t=e.toString()})),t},tableHeight(){let t=window.innerHeight-170;return console.log("table height",t),t<0&&(t=1e3),t}},watch:{NewParams:function(t,e){console.log("params changed",t),this.$router.replace({path:this.$router.path,query:{cluster:this.params.cluster,svr:""!==this.params.svr?this.params.svr:void 0}}).catch((t=>t))}},mounted(){if(!0!==this.parseURLParams()){const t=localStorage.getItem("cmd_cluster_"),e=localStorage.getItem("cmd_svr_");t&&""!==t&&(this.params.cluster=t),e&&""!==e&&(this.params.svr=e,this.svrRows=[e])}this.queryIDs(),this.timer||(console.log("create timer",this.timer),this.timer=setInterval((()=>{this.queryHistory()}),1e3)),this.$once("hook:beforeDestroy",(()=>{console.log("beforeDestroy cmd page",this.timer),this.timer&&(clearInterval(this.timer),this.timer=null)}))},unmounted(){console.log("unmounted cmd page"),this.timer&&(clearInterval(this.timer),this.timer=null)},methods:{parseURLParams(){return!!this.$route.query.cluster&&(this.params.cluster=this.$route.query.cluster,this.$route.query.svr&&(this.params.svr=this.$route.query.svr,this.svrRows=[this.params.svr]),!0)},queryIDs(){const t=this.$store.getters["cache/GetOptions"](this.type);if(t)return this.ids=t,void this.fillIDs();console.log("get new ids"),this.$request.get("/api/query/options",{params:{type:this.type}}).then((t=>{const e=t.data;"ok"===e.result?e.data&&0!==e.data.length?(this.ids=e.data,console.log("get ids",this.ids),this.$store.commit("cache/SetOptions",{key:this.type,value:this.ids}),this.fillIDs()):this.$message.error("没有数据"):this.$message.error(`查询失败：${e.result}`)})).catch((t=>{console.log(t),this.$message.error(t)}))},queryHistory(){this.$request.post("/api/cmd/history",{zone:this.params.cluster,svr:this.params.svr}).then((t=>{const e=t.data;if("ok"!==e.result)return void this.$message.error(`查询失败：${e.result}`);if(!e.data||0===e.data.length)return console.log("没有数据"),void(this.recordData=[]);console.log("get history",e.data);let s=0;e.data.forEach((t=>{t.key=s,s+=1,t.displaytyp=t.typ.replaceAll("Prof","")})),this.recordData=e.data})).catch((t=>{console.log(t),this.$message.error(t)}))},updateNote(t){this.$request.post("/api/cmd/update-history",{starttime:t.starttime,id:t.id,typ:t.typ,comment:t.comment}).then((t=>{const e=t.data;"ok"===e.result?this.$message.success("更新成功"):this.$message.error(`查询失败：${e.result}`)})).catch((t=>{console.log(t),this.$message.error(t)}))},fillIDs(){this.params.cluster=l(this.params.cluster,this.clusterlist),this.params.svr=l(this.params.svr,this.svrlist)},clusterChange(t){console.log(`selected cluster ${t}`),localStorage.setItem("cmd_cluster_",t),this.params.svr=l(this.params.svr,this.svrlist),this.svrChange(this.params.svr)},svrChange(t){console.log(`selected svr ${t}`),this.svrRows=[t],localStorage.setItem("cmd_svr_",t),this.idsRows=[],this.queryHistory()},clickSvr({row:t}){this.params.svr=t.svr,this.svrChange(t.svr)},idsSelectChange(t,{selectedRowData:e}){this.idsRows=t},insertIdsRow(t){let e=!1;this.idsRows.forEach((s=>{if(s===t)return e=!0,!1})),!1===e&&this.idsRows.push(t)},handleClickCollect({row:t},e){this.collectType=e,this.insertIdsRow(t.value),this.dialogVisible=!0},handleClickDetail({row:t}){console.log("跳转到",t);const e=i(t.starttime,"YYYY-MM-DD HH:mm:ss");this.$router.push({path:`/dashboard/${c(t.typ)}`,query:{meshId:t.id.replaceAll("/","_"),startTime:e.add(-3,"hour").format("YYYY-MM-DD HH:mm:ss"),endTime:e.add(3,"hour").format("YYYY-MM-DD HH:mm:ss"),tabValue:"list",selectedDt:t.starttime}})},onClick(t){console.log("点击确认",t),this.$request.post("/api/cmd/startcollect",{ids:this.idsRows,typ:this.collectType}).then((t=>{if("ok"===t.data.result)return this.$message.success("下发采集成功"),void this.queryHistory();this.$message.error(`下发采集失败${t.data.result}`)})).catch((t=>{console.log(t)})).finally((()=>{console.log("finally"),this.dialogVisible=!1}))}}},d=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"all"},[s("div",{staticClass:"content"},[s("t-layout",[s("t-header",[s("div",{staticClass:"header"},[s("span",{staticStyle:{flex:"none","line-height":"40px"}},[t._v("    Zone:    ")]),t._v(" "),s("div",{staticStyle:{width:"290px"}},[s("t-select",{attrs:{bordered:"",showArrow:"",size:"large",options:t.clusterlist,filterable:""},on:{change:t.clusterChange},model:{value:t.params.cluster,callback:function(e){t.$set(t.params,"cluster",e)},expression:"params.cluster"}})],1),t._v(" "),s("div",{staticStyle:{width:"266px"}}),t._v(" "),s("span",{staticStyle:{"line-height":"40px","font-size":"24px"}},[t._v("节点列表")]),t._v(" "),s("span",{staticStyle:{position:"absolute",right:"36%","line-height":"40px","font-size":"24px"}},[t._v("采集历史")])])]),t._v(" "),s("t-layout",[s("t-aside",{staticClass:"cmdsider"},[s("div",{staticClass:"left"},[s("div",{staticClass:"table-container"},[s("t-table",{staticClass:"tdesign-demo__select-single",attrs:{maxHeight:t.tableHeight,data:t.svrlist,columns:t.svrCol,rowKey:"svr",verticalAlign:"top",bordered:!1,"table-layout":"fixed","selected-row-keys":t.svrRows,showHeader:!1},on:{"row-click":t.clickSvr},scopedSlots:t._u([{key:"num",fn:function(e){return[s("div",[s("t-tag",{attrs:{shape:"round",theme:"primary",variant:"outline"}},[t._v(t._s(e.row.num))])],1)]}}])})],1)])]),t._v(" "),s("t-content",{staticClass:"right-content"},[s("div",{staticClass:"right"},[s("div",{staticClass:"table-container1"},[s("t-table",{staticClass:"tdesign-demo__select-single2",attrs:{maxHeight:t.tableHeight,data:t.idlist,columns:t.idsCol,rowKey:"value",verticalAlign:"top",hover:"",bordered:!1,"table-layout":"auto","selected-row-keys":t.idsRows,loading:t.idsLoading,filterRow:function(){return null}},on:{"select-change":t.idsSelectChange},scopedSlots:t._u([{key:"op",fn:function(e){return[s("div",{staticClass:"opdiv"},[s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfCPU")}}},[t._v("CPU")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfMemory")}}},[t._v("内存")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfBlock")}}},[t._v("Block")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfMutex")}}},[t._v("Mutex")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfGoroutine")}}},[t._v("Goroutine")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfThreadCreate")}}},[t._v("Thread")]),t._v(" "),s("a",{staticClass:"mylink",on:{click:function(s){return t.handleClickCollect(e,"ProfTrace")}}},[t._v("Trace")])])]}}])})],1),t._v(" "),s("div",{staticClass:"table-container2"},[s("t-table",{attrs:{maxHeight:t.tableHeight,data:t.recordData,columns:t.RecordColumns,rowKey:"key",verticalAlign:"top",hover:"",bordered:!1,"table-layout":"fixed",loading:t.recordLoading,filterRow:function(){return null}},scopedSlots:t._u([{key:"process",fn:function(e){return[s("div",{staticStyle:{width:"140px"}},["0001-01-01 00:00:00"===e.row.endtime?s("t-loading",{attrs:{size:"small"}}):s("span",{staticStyle:{color:"#3AA873"}},[t._v("已完成")])],1)]}},{key:"op",fn:function(e){return[s("div",{staticStyle:{width:"140px"}},[s("t-link",{attrs:{disabled:"0001-01-01 00:00:00"===e.row.endtime,theme:"primary"},on:{click:function(s){return t.handleClickDetail(e)}}},[t._v("查看详情")])],1)]}}])})],1)])])],1)],1)],1),t._v(" "),s("t-dialog",{attrs:{header:"采集确认",visible:t.dialogVisible,onConfirm:t.onClick,width:"600px"},on:{"update:visible":function(e){t.dialogVisible=e}}},[s("span",[t._v(t._s("确认采集："+t.collectBody+"的"+t.collectType+"吗？"))]),t._v(" "),s("div",{staticClass:"dialog-tabs"})])],1)};d._withStripped=!0;const h={};var u=r(n,d,[],!1,(function(t){for(let e in h)this[e]=h[e]}),"414b5369",null,null).exports;export default u;
