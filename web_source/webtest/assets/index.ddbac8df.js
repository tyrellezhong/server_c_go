var t=Object.defineProperty,e=Object.prototype.hasOwnProperty,s=Object.getOwnPropertySymbols,a=Object.prototype.propertyIsEnumerable,r=(e,s,a)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[s]=a,i=(t,i)=>{for(var o in i||(i={}))e.call(i,o)&&r(t,o,i[o]);if(s)for(var o of s(i))a.call(i,o)&&r(t,o,i[o]);return t};import{n as o,p as l,s as n}from"./index.91c1d8ee.js";import{g as c,p as u,a as m}from"./utils.6db6fdf7.js";import"./vendor.3a85f146.js";const h=[{label:"dev",value:"dev"},{label:"daily",value:"daily"}],d=[{label:"--default--",value:""},{label:"profsvr",value:"profsvr"},{label:"attributesvr",value:"attributesvr"},{label:"herosvr",value:"herosvr"}],p={cpuSwitch:!0,cpuInterval:60,cpuDuration:500,cpuThreshold:0,memSwitch:!0,memInterval:60,memThreshold:0},v=[{align:"center",width:"100",className:"row",colKey:"version",title:"版本"},{width:200,colKey:"time",title:"时间"},{align:"center",width:100,colKey:"author",title:"修改人"},{align:"center",title:"操作",colKey:"op",width:100,cell:"op"}];var f=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("t-page-header",[t._v("采集配置")]),t._v(" "),s("div",{class:t.prefix+"-panel"},[s("t-form",{ref:"form",staticClass:"base-form",attrs:{data:t.formData,rules:t.rules,labelAlign:"left"},on:{reset:t.onReset,submit:t.onSubmit}},[s("input",{staticStyle:{visibility:"hidden"},attrs:{type:"submit"}}),t._v(" "),s("t-form-item",{attrs:{label:"集群",name:"cluster"}},[s("t-select",{staticStyle:{width:"200px"},attrs:{creatable:"",filterable:"",placeholder:"-请选择-",options:t.cluster_options},on:{change:t.onClusterChange,create:t.createClusterOptions},model:{value:t.cluster,callback:function(e){t.cluster=e},expression:"cluster"}}),t._v(" "),s("span",[t._v("  服务  ")]),t._v(" "),s("t-select",{staticStyle:{width:"200px"},attrs:{creatable:"",filterable:"",placeholder:"-请选择-",options:t.svr_options},on:{change:t.onSvrChange,create:t.createSvrOptions},model:{value:t.svr,callback:function(e){t.svr=e},expression:"svr"}}),t._v(" "),s("t-button",{staticClass:"queryButton",attrs:{theme:"primary"},on:{click:t.onQuery}},[t._v("查询")]),t._v(" "),s("span",{staticClass:"version_link",on:{click:t.onVersion}},[t._v(t._s(t.version_info))])],1),t._v(" "),s("t-divider",{attrs:{align:"left"}},[t._v("CPU")]),t._v(" "),s("t-form-item",{staticClass:"item-first",attrs:{label:"开关",name:"cpuSwitch"}},[s("t-radio-group",{model:{value:t.cpuSwitch,callback:function(e){t.cpuSwitch=e},expression:"cpuSwitch"}},[s("t-radio",{attrs:{value:"open"}},[t._v("开")]),t._v(" "),s("t-radio",{attrs:{value:"close"}},[t._v("关")])],1)],1),t._v(" "),s("t-form-item",{attrs:{label:"采集周期(s)",name:"cpuInterval"}},[s("t-input-number",{attrs:{theme:"normal",size:"medium",max:1e6,min:1},model:{value:t.formData.cpuInterval,callback:function(e){t.$set(t.formData,"cpuInterval",e)},expression:"formData.cpuInterval"}})],1),t._v(" "),s("t-form-item",{attrs:{label:"采集时长(ms)",name:"cpuDuration"}},[s("t-input-number",{attrs:{theme:"normal",size:"medium",max:1e4,min:1},model:{value:t.formData.cpuDuration,callback:function(e){t.$set(t.formData,"cpuDuration",e)},expression:"formData.cpuDuration"}})],1),t._v(" "),s("t-form-item",{attrs:{label:"采集阈值",name:"cpuThreshold"}},[s("t-input-number",{attrs:{theme:"normal",size:"medium",max:1e5,min:0},model:{value:t.formData.cpuThreshold,callback:function(e){t.$set(t.formData,"cpuThreshold",e)},expression:"formData.cpuThreshold"}})],1),t._v(" "),s("t-divider",{attrs:{align:"left"}},[t._v("Memory")]),t._v(" "),s("t-form-item",{staticClass:"item-first",attrs:{label:"开关",name:"memSwitch"}},[s("t-radio-group",{model:{value:t.memSwitch,callback:function(e){t.memSwitch=e},expression:"memSwitch"}},[s("t-radio",{attrs:{value:"open"}},[t._v("开")]),t._v(" "),s("t-radio",{attrs:{value:"close"}},[t._v("关")])],1)],1),t._v(" "),s("t-form-item",{attrs:{label:"采集周期(s)",name:"memInterval"}},[s("t-input-number",{attrs:{theme:"normal",size:"medium",max:1e6,min:1},model:{value:t.formData.memInterval,callback:function(e){t.$set(t.formData,"memInterval",e)},expression:"formData.memInterval"}})],1),t._v(" "),s("t-form-item",{attrs:{label:"采集阈值",name:"memThreshold"}},[s("t-input-number",{attrs:{theme:"normal",size:"medium",max:1e12,min:0},model:{value:t.formData.memThreshold,callback:function(e){t.$set(t.formData,"memThreshold",e)},expression:"formData.memThreshold"}})],1),t._v(" "),s("t-form-item",[s("t-button",{attrs:{theme:"primary",type:"submit"}},[t._v("提交")]),t._v(" "),s("t-button",{attrs:{theme:"default",variant:"base"}},[t._v("取消")])],1)],1)],1),t._v(" "),s("t-drawer",{attrs:{visible:t.configlist_visible,size:t.drawerSize,header:"历史配置"},on:{"update:visible":function(e){t.configlist_visible=e}},scopedSlots:t._u([{key:"footer",fn:function(){},proxy:!0}])},[s("t-table",{attrs:{rowKey:"index",data:t.configlist_data,columns:t.configlist_columns,pagination:t.pagination},scopedSlots:t._u([{key:"op-column",fn:function(){return[s("p",[t._v("操作")])]},proxy:!0},{key:"op",fn:function(e){return[s("a",{staticClass:"configload",on:{click:function(s){return t.onLoadCfg(e)}}},[t._v("加载")]),t._v(" "),"admin"===t.role?s("a",{staticClass:"configload",on:{click:function(s){return t.onDelCfg(e)}}},[t._v("删除")]):t._e()]}}])})],1),t._v(" "),s("t-dialog",{attrs:{header:"是否确认删除",body:t.delConfirmBody,visible:t.delConfirmVisible,onCancel:t.onCancelDelete},on:{"update:visible":function(e){t.delConfirmVisible=e},confirm:t.onConfirmDelete}})],1)};f._withStripped=!0;const g={};var b=o({data:()=>({prefix:l,role:n.state.user.role,cluster:"dev",options:[],cluster_options:h,svr:"",svr_options:d,version:0,optionsReady:!1,dt:"",cpuSwitch:"open",memSwitch:"open",formData:i({},p),rules:{cluster:[{required:!0,message:"",type:"error"}],cpuSwitch:[{required:!0,message:"",type:"error"}],cpuInterval:[{required:!0,message:"请输入CPU采集周期",type:"error"}],cpuDuration:[{required:!0,message:"请输入CPU采集时长",type:"error"}],memSwitch:[{required:!0,message:"",type:"error"}],memInterval:[{required:!0,message:"请输入内存采集周期",type:"error"}]},configlist_data:[],configlist_columns:v,pagination:{defaultCurrent:1,defaultPageSize:15,total:0},drawerSize:"600px",configlist_visible:!1,delConfirmBody:"",delConfirmVisible:!1,deleteRow:{}}),computed:{version_info(){return`当前版本是${this.version}, 修改于${this.dt}`}},mounted(){this.queryOptions()},methods:{formatResponse:t=>i(i({},t),{error:"上传失败，请重试",url:t.url}),changeStatus(){this.stepSuccess=!this.stepSuccess},onReset(){this.$message.warning("取消新建")},onSubmit({e:t,validateResult:e}){"BUTTON"===t.submitter.nodeName?!1!==e?(this.formData.cpuSwitch="open"===this.cpuSwitch,this.formData.memSwitch="open"===this.memSwitch,this.$request.post("/api/config/collect",{cluster:this.cluster,svr:this.svr,data:this.formData},{timeout:1e5,retry:0}).then((t=>{const e=t.data;"ok"===e.result?(this.version=this.version+1,this.$message.success("设置成功")):this.$message.error(`设置失败：${e.result}`)})).catch((function(t){console.log(t),this.$message.success(`设置失败：${t}`)}))):this.$message.error("参数不正确"):console.log("forbidden submit form input's enter")},queryOptions(){this.$request.get("/api/config/options").then((t=>{const e=t.data;"ok"===e.result?e.data&&0!==e.data.length?(this.options=e.data,this.cluster_options=c(this.options),this.cluster=u("",this.cluster_options),this.fillSvrList(),this.onQuery(),this.optionsReady=!0):this.$message.error("空的选项列表"):this.$message.error(`查询失败：${e.result}`)})).catch((t=>{this.$message.error(t),console.log(t)}))},onClusterChange(t){console.log("you select cluster:",t),this.optionsReady,console.log(t,this.cluster),this.fillSvrList(),this.onQuery()},onSvrChange(t){console.log("you select server:",t),this.optionsReady,this.onQuery()},fillSvrList(){const t=m(this.options,this.cluster);for(let e=0;e<t.length;e++)""===t[e].label&&(t[e].label="--default--");this.svr_options=t,this.svr=u("",this.svr_options)},onQuery(){this.$request.get("/api/config/collect/query",{params:{cluster:this.cluster,svr:this.svr}}).then((t=>{const e=t.data;if("ok"===e.result){if(!e.data)return console.log("没有对应数据"),this.version=-1,void(this.dt="");this.fillPageData(e.data),this.version=e.data.version,this.dt=e.data.dt,this.formData.cpuInterval=e.data.data.cpuInterval,this.formData.cpuDuration=e.data.data.cpuDuration,this.formData.memInterval=e.data.data.memInterval,this.cpuSwitch=!0===e.data.data.cpuSwitch?"open":"close",this.memSwitch=!0===e.data.data.memSwitch?"open":"close"}else this.$message.error(`查询失败：${e.result}`)})).catch((function(t){console.log(t)}))},onVersion(){this.configlist_visible=!0,this.$request.get("/api/config/collect/query/history",{params:{cluster:this.cluster,svr:this.svr}}).then((t=>{const e=t.data;"ok"===e.result?e.data?(this.configlist_data=function(t){const e=[];return t.forEach((t=>{e.push({version:t.version,time:t.dt,author:t.author,data:t})})),e}(e.data),this.pagination.total=this.configlist_data.length):console.log("empty config history"):this.$message.error(`查询失败：${e.result}`)})).catch((function(t){console.log(t)}))},fillPageData(t){this.version=t.version,this.dt=t.dt,this.formData.cpuInterval=t.data.cpuInterval,this.formData.cpuDuration=t.data.cpuDuration,this.formData.cpuThreshold=t.data.cpuThreshold,this.formData.memInterval=t.data.memInterval,this.formData.memThreshold=t.data.memThreshold,this.cpuSwitch=!0===t.data.cpuSwitch?"open":"close",this.memSwitch=!0===t.data.memSwitch?"open":"close"},onConfiglistConfirm(){this.configlist_visible=!1},onLoadCfg({row:t}){this.fillPageData(t.data)},onDelCfg({row:t}){this.deleteRow=t,this.delConfirmBody=`确认删除${this.cluster}中的${this.svr}，版本${t.version}(${t.time})的配置吗？`,this.delConfirmVisible=!0},onConfirmDelete(){this.$request.post("/api/config/delete",null,{params:{cluster:this.cluster,svr:this.svr,ver:this.deleteRow.version}}).then((t=>{if("ok"===t.data.result)return this.$message.success("删除成功"),void this.onVersion();console.log("删除失败",t.data.result),this.$message.error(`删除失败:${t.data.result}`)})).catch((t=>{console.log(t),this.$message.error("删除失败")})),this.delConfirmVisible=!1},onCancelDelete(){this.delConfirmVisible=!1},createClusterOptions(t){this.cluster_options.push({label:t,value:t})},createSvrOptions(t){this.svr_options.push({label:t,value:t})}}},f,[],!1,(function(t){for(let e in g)this[e]=g[e]}),null,null,null).exports;export default b;
