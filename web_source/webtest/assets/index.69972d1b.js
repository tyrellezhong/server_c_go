var e=Object.defineProperty,t=Object.prototype.hasOwnProperty,a=Object.getOwnPropertySymbols,s=Object.prototype.propertyIsEnumerable,i=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,n=(e,n)=>{for(var l in n||(n={}))t.call(n,l)&&i(e,l,n[l]);if(a)for(var l of a(n))s.call(n,l)&&i(e,l,n[l]);return e};import{e as l,p as r,n as o}from"./index.91c1d8ee.js";import"./vendor.3a85f146.js";const d={ADMIN:"admin",GENERAL:"general",GUEST:"guest"},c=[{label:"管理员",value:d.ADMIN},{label:"普通用户",value:d.GENERAL},{label:"访客",value:d.GUEST}],h=[{content:"管理员",value:d.ADMIN},{content:"普通用户",value:d.GENERAL},{content:"访客",value:d.GUEST}],u=[{colKey:"row-select",type:"multiple",width:"50"},{title:"用户名",minWidth:"200",width:200,align:"left",ellipsis:!0,colKey:"name"},{title:"角色",colKey:"role",width:150,cell:{col:"role"}},{align:"left",width:200,ellipsis:!0,colKey:"op",title:"操作"}];function g(e,t){for(let a=0;a<e.length;a++)if(e[a].name===t)return a;return-1}var p={name:"list-base",components:{SearchIcon:l},data:()=>({prefix:r,ROLE:d,dataLoading:!1,data:[],showData:[],selectedRowKeys:[],columns:u,rowKey:"name",verticalAlign:"top",hover:!0,pagination:{defaultPageSize:10,total:0,defaultCurrent:1},deleteIdx:"",currentRow:{},delConfirmVisible:!1,changeConfirmBody:"",changeConfirmVisible:!1,wantSetUser:{},addUserVisible:!1,newUsers:"",user_role:"general",RoleOptions:c,TableRoleOptions:h}),computed:{delConfirmBody(){return""!==this.deleteIdx?`用户: ${this.deleteIdx}`:""}},mounted(){this.loadUsers()},methods:{loadUsers(){this.dataLoading=!0,this.$request.get("/api/user/get-users").then((e=>{e.data&&"ok"===e.data.result?this.setData(e.data.users):console.log("请求失败",e.data)})).catch((e=>{console.log(e)})).finally((()=>{this.dataLoading=!1}))},setData(e){this.data=e,this.updateShowData(e)},updateShowData(e){this.showData=e,this.pagination=n(n({},this.pagination),{total:this.showData.length})},filter(e){let{data:t}=this;""!==e&&(t=this.data.filter((t=>t.name.includes(e)))),this.updateShowData(t)},onFilterChange(e){this.filter(e)},rehandlePageChange(e,t){},rehandleSelectChange(e){this.selectedRowKeys=e},rehandleChange(e,t){},handleClickDetail(){console.log("点击了详情")},onAddUser(){this.addUserVisible=!0},handleClickDelete({row:e}){this.deleteIdx=e.name,this.delConfirmVisible=!0},onConfirmDelete(){const e=g(this.data,this.deleteIdx);if(-1===e)return void this.$message.error("找不到用户",this.deleteIdx);const t=this.data[e];this.data.splice(e,1),this.pagination.total=this.data.length;const a=this.selectedRowKeys.indexOf(this.deleteIdx);a>-1&&this.selectedRowKeys.splice(a,1),this.delConfirmVisible=!1;let s=!0;this.$request.post("/api/user/delete",{users:[{name:this.deleteIdx}]}).then((e=>{"ok"!==e.data.result?(s=!1,this.$message.error(`删除失败:${e.data.result}`)):this.$message.success("删除成功")})).catch((e=>{console.log(e),this.$message.error("删除失败:内部错误"),s=!1})).finally((()=>{!1===s&&this.data.splice(e,0,t),this.resetIdx()}))},onCancelDelete(){this.resetIdx()},resetIdx(){this.deleteIdx=""},onConfirmAddUser(){const e=[];this.newUsers.split(/[\s\n]/).forEach((t=>{""!==t&&e.push({name:t,role:this.user_role})})),this.$request.post("/api/user/insert-users",{users:e}).then((e=>{"ok"!==e.data.result?this.$message.error(`新增用户失败${e.data.result}`):this.$message.success("新增用户成功")})).catch((e=>{console.log(e)})).finally((()=>{this.addUserVisible=!1,this.loadUsers()}))},onCancelAddUser(){this.addUserVisible=!1},handleDropClick(e,{e:t}){t.preventDefault(),e.value!==this.currentRow.role&&(this.changeConfirmBody=`将${this.currentRow.name}的角色改为${e.content}吗？`,this.wantSetUser={name:this.currentRow.name,role:e.value},this.changeConfirmVisible=!0)},handleRowClick({row:e}){this.currentRow=e},onConfirmChange(){this.changeConfirmVisible=!1;const e=g(this.data,this.wantSetUser.name);if(-1===e)return void this.$message.error(`找不到用户${this.wantSetUser.name}`);const t=this.data[e].role;this.data[e].role=this.wantSetUser.role,this.$request.post("/api/user/update",null,{params:{name:this.wantSetUser.name,role:this.wantSetUser.role}}).then((a=>{"ok"!==a.data.result?(this.$message.error(`更新失败:${a.data.result}`),this.data[e].role=t):this.$message.success("更新成功")})).catch((a=>{this.$message.error("更新失败",a),this.data[e].role=t}))},onCancelChange(){this.changeConfirmVisible=!1}}},f=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"config-user"},[a("t-page-header",[e._v(" 用户管理 ")]),e._v(" "),a("div",{class:e.prefix+"-panel"},[a("t-row",{class:e.prefix+"-operater-row",attrs:{justify:"space-between"}},[a("div",[a("t-button",{on:{click:e.onAddUser}},[e._v("增加用户")]),e._v(" "),e.selectedRowKeys.length?a("p",{class:e.prefix+"-selected-count"},[e._v("已选"+e._s(e.selectedRowKeys.length)+"项")]):e._e()],1),e._v(" "),a("div",{class:e.prefix+"-search-input"},[a("t-input",{attrs:{placeholder:"请输入你需要搜索的用户",clearable:""},on:{change:e.onFilterChange}},[a("SearchIcon",{attrs:{slot:"suffix-icon",size:"20px"},slot:"suffix-icon"})],1)],1)]),e._v(" "),a("div",{staticClass:"table-container"},[a("t-table",{attrs:{data:e.showData,columns:e.columns,rowKey:e.rowKey,verticalAlign:e.verticalAlign,hover:e.hover,pagination:e.pagination,"selected-row-keys":e.selectedRowKeys,loading:e.dataLoading,"filter-value":{name:"raine"},filterRow:function(){return null}},on:{"page-change":e.rehandlePageChange,change:e.rehandleChange,"select-change":e.rehandleSelectChange,"row-click":e.handleRowClick},scopedSlots:e._u([{key:"role",fn:function(t){var s=t.row;return[a("t-dropdown",{attrs:{minColumnWidth:88,options:e.TableRoleOptions,trigger:"click"},on:{click:e.handleDropClick}},[a("t-button",{attrs:{variant:"text"}},[s.role===e.ROLE.ADMIN?a("t-tag",{attrs:{theme:"danger",variant:"light"}},[e._v("管理员")]):e._e(),e._v(" "),s.role===e.ROLE.GUEST?a("t-tag",{attrs:{theme:"warning",variant:"light"}},[e._v("访客")]):e._e(),e._v(" "),s.role===e.ROLE.GENERAL?a("t-tag",{attrs:{theme:"success",variant:"light"}},[e._v("普通用户")]):e._e()],1)],1)]}},{key:"op",fn:function(t){return[a("a",{class:e.prefix+"-link",on:{click:function(a){return e.handleClickDetail(t)}}},[e._v("详情")]),e._v(" "),a("a",{class:e.prefix+"-link",on:{click:function(a){return e.handleClickDelete(t)}}},[e._v("删除")])]}}])})],1)],1),e._v(" "),a("t-dialog",{attrs:{header:"是否确认删除",body:e.delConfirmBody,visible:e.delConfirmVisible,onCancel:e.onCancelDelete},on:{"update:visible":function(t){e.delConfirmVisible=t},confirm:e.onConfirmDelete}}),e._v(" "),a("t-dialog",{attrs:{header:"是否确认更改",body:e.changeConfirmBody,visible:e.changeConfirmVisible,onCancel:e.onCancelChange},on:{"update:visible":function(t){e.changeConfirmVisible=t},confirm:e.onConfirmChange}}),e._v(" "),a("t-dialog",{attrs:{header:"新增用户",visible:e.addUserVisible,onCancel:e.onCancelAddUser},on:{"update:visible":function(t){e.addUserVisible=t},confirm:e.onConfirmAddUser}},[a("t-textarea",{staticClass:"usersInput",attrs:{placeholder:"请输入用户英文名，多个用户换行输入",name:"description"},model:{value:e.newUsers,callback:function(t){e.newUsers=t},expression:"newUsers"}}),e._v(" "),a("p",[e._v("角色")]),e._v(" "),a("t-select",{attrs:{options:e.RoleOptions},model:{value:e.user_role,callback:function(t){e.user_role=t},expression:"user_role"}})],1)],1)};f._withStripped=!0;const m={};var v=o(p,f,[],!1,(function(e){for(let t in m)this[t]=m[t]}),null,null,null).exports;export default v;
